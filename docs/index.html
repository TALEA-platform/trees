<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8" />
    <title>Alberi in gestione al comune di Bologna</title>
    <link rel="stylesheet" href="assets/vendor/maplibre-gl/maplibre-gl.css" crossorigin="anonymous">
    <script src="assets/vendor/maplibre-gl/maplibre-gl.js" crossorigin="anonymous"></script>
    <script src="assets/vendor/pmtiles/pmtiles.js"></script>
    <style>
      html,
      body,
      #map {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 10px;
        max-width: 300px;
        font-family: sans-serif;
        font-size: 13px;
        line-height: 1.4em;
        border-radius: 4px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        z-index: 1;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <div id="info">Passa il mouse su un albero per i dettagli.</div>

    <script>
      // Inizializza protocollo PMTiles
      const protocol = new pmtiles.Protocol();
      maplibregl.addProtocol("pmtiles", protocol.tile);

      const coloriFamiglia = {
        "Fagaceae": "#2e8b57",
        "Betulaceae": "#66cdaa",
        "Cupressaceae": "#3cb371",
        "Pinaceae": "#228b22",
        "Fabaceae": "#9acd32",
        "Rosaceae": "#7ccd7c",
        "Ulmaceae": "#8fbc8f",
        "Malvaceae": "#90ee90",
        "Oleaceae": "#b0e57c",
        "Moraceae": "#6b8e23",
        "sconosciuto": "#a9dfbf"
      };

const urlParams = new URLSearchParams(window.location.search);
const lat = parseFloat(urlParams.get("lat")) || 44.49164;
const lng = parseFloat(urlParams.get("lng")) || 11.35416;
const zoom = parseFloat(urlParams.get("zoom")) || 15;

const map = new maplibregl.Map({
  container: "map",
  style: "https://tiles.openfreemap.org/styles/liberty",
  center: [lng, lat],
  zoom: zoom
});


      map.addControl(new maplibregl.NavigationControl(), 'top-right');
      map.addControl(new maplibregl.ScaleControl({ maxWidth: 200, unit: 'metric' }), 'bottom-left');

      const popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });
      const infoPanel = document.getElementById("info");
  
      function updateUrlFromMap(map) {
        const center = map.getCenter();
        const zoom = map.getZoom().toFixed(2);
        const lat = center.lat.toFixed(5);
        const lng = center.lng.toFixed(5);

        const newUrl = `${location.pathname}?lat=${lat}&lng=${lng}&zoom=${zoom}`;
        window.history.replaceState({}, '', newUrl);
      }

map.on('moveend', () => updateUrlFromMap(map));

      map.on('style.load', () => {
        map.addSource("alberi", {
          type: "vector",
          url: "pmtiles://alberi.pmtiles"
        });

        map.addLayer({
          id: "alberi.mbtiles",
          type: "circle",
          source: "alberi",
          "source-layer": "alberi",
          paint: {
            // Cerchio proporzionato ma con scala ridotta rispetto a height
            "circle-radius": [
              "interpolate",
              ["linear"],
              ["zoom"],
              13, [
                "interpolate", ["linear"], ["get", "height"],
                0, 1.5,
                30, 1
              ],
              18, [
                "interpolate", ["linear"], ["get", "height"],
                0, 4,
                30, 12
              ]
            ],
            "circle-color": [
              "match", ["get", "family"],
              "Fagaceae", "#2e8b57",
              "Betulaceae", "#66cdaa",
              "Cupressaceae", "#3cb371",
              "Pinaceae", "#228b22",
              "Fabaceae", "#9acd32",
              "Rosaceae", "#7ccd7c",
              "Ulmaceae", "#8fbc8f",
              "Malvaceae", "#90ee90",
              "Oleaceae", "#b0e57c",
              "Moraceae", "#6b8e23",
              "#a9dfbf"
            ],
            "circle-stroke-color": [
              "match", ["get", "family"],
              "Fagaceae", "#2e8b57",
              "Betulaceae", "#66cdaa",
              "Cupressaceae", "#3cb371",
              "Pinaceae", "#228b22",
              "Fabaceae", "#9acd32",
              "Rosaceae", "#7ccd7c",
              "Ulmaceae", "#8fbc8f",
              "Malvaceae", "#90ee90",
              "Oleaceae", "#b0e57c",
              "Moraceae", "#6b8e23",
              "#a9dfbf"
            ],
            "circle-stroke-width": 1,
            "circle-opacity": 0.7
          }
        });

        map.addLayer({
          id: "alberi-tronco",
          type: "circle",
          source: "alberi",
          "source-layer": "alberi",
          paint: {
            "circle-radius": 1.5,
            "circle-color": "#8b4513", // marrone scuro
            "circle-stroke-color": "#5c3317", // bordo leggermente diverso
            "circle-stroke-width": 0.5,
            "circle-opacity": 1
          }
        }, "alberi.mbtiles");

        map.on('mousemove', 'alberi.mbtiles', (e) => {
          const feature = e.features[0];
          const props = feature.properties;

          popup.setLngLat(e.lngLat)
            .setHTML(`<strong>${props.nome || props.classe}</strong><br/>Famiglia: ${props.family}`)
            .addTo(map);

          infoPanel.innerHTML = `
        <strong>${props.nome || props.classe}</strong><br/>
        <ul style="padding-left: 1em;">
          <li><b>Famiglia:</b> ${props.family}</li>
          <li><b>Classe:</b> ${props.classe}</li>
          <li><b>Dimora:</b> ${props.dimora}</li>
          <li><b>Irrigazione:</b> ${props.irriga}</li>
          <li><b>Pregio:</b> ${props.pregio}</li>
          <li><b>Data inventario:</b> ${props.data_inv}</li>
          <li><b>Data aggiornamento:</b> ${props.data_agg}</li>
          <li><b>Distanza edificio:</b> ${props.d_edif}</li>
          <li><b>Data impianto:</b> ${props.data_impnt}</li>
          <li><b>In patrimonio:</b> ${props.in_patrim}</li>
          <li><b>Anni impianto:</b> ${props.anni_impnt}</li>
          <li><b>Altezza:</b> ${props.height} m</li>
          <li><b>Circonferenza chioma:</b> ${props.girth} cm</li>
          <li><b>Tipo chioma:</b> ${props.chioma_tipo}</li>
        </ul>
      `;
        });

        map.on('mouseleave', 'alberi.mbtiles', () => {
          popup.remove();
          infoPanel.innerHTML = "Passa il mouse su un albero per i dettagli.";
        });
      });
    </script>
  </body>

</html>